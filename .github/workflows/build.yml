name: Build and push multi-arch images

on:
    push:
        branches: master

jobs:
    Build:
        runs-on: ubuntu-latest
        steps:
            - name: Code setup
              uses: actions/checkout@v3
              with:
                  submodules: recursive

            - name: QEMU setup
              uses: docker/setup-qemu-action@v2

            - name: Buildx setup
              uses: docker/setup-buildx-action@v2

            - name: DockerHub setup
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.NAME }}
                  password: ${{ secrets.TOKEN }}

            - name: Tags setup
              run: |
                  echo "DATE=$(date +%Y.%m.%d)" >> $GITHUB_ENV
                  echo "LATEST=latest" >> $GITHUB_ENV

            - name: Build and push - Python 2.7
              uses: docker/build-push-action@v2
              with:
                  # Build properties
                  file: template/Dockerfile-2.7
                  context: template
                  platforms: linux/386,linux/amd64,linux/arm/v7,linux/arm64/v8

                  # Docker properties
                  push: true
                  tags: |
                      webhood/2.7:${{ env.DATE }}
                      webhood/2.7:${{ env.LATEST }}

            - name: Build and push - Python 3.8
              uses: docker/build-push-action@v2
              with:
                  # Build properties
                  file: template/Dockerfile-3.8
                  context: template
                  platforms: linux/386,linux/amd64,linux/arm/v7,linux/arm64/v8

                  # Docker properties
                  push: true
                  tags: |
                      webhood/3.8:${{ env.DATE }}
                      webhood/3.8:${{ env.LATEST }}
