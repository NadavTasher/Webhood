name: Build and push multi-arch images

on:
    push:
        branches: master

jobs:
    Build:
        runs-on: ubuntu-latest
        steps:
            -
                name: Code setup
                uses: actions/checkout@v2
                with:
                    submodules: recursive

            -
                name: QEMU setup
                uses: docker/setup-qemu-action@v1

            -
                name: Buildx setup
                uses: docker/setup-buildx-action@v1

            -
                name: DockerHub setup
                uses: docker/login-action@v1 

                with:
                    # What is our username?
                    username: ${{ secrets.NAME }}
                    
                    # What is our password?
                    password: ${{ secrets.TOKEN }}

            - 
                name: Tags setup
                run: |
                    echo "DATE=$(date +%Y.%m.%d)" >> $GITHUB_ENV
                    echo "LATEST=latest" >> $GITHUB_ENV

            -
                name: Build and push - Python 2.7
                uses: docker/build-push-action@v2

                with:
                    # Do we want to push the images to DockerHub?
                    push: true

                    # What is out build context?
                    file: template/Dockerfile-2.7
                    context: template

                    # What are our target platforms?
                    platforms: linux/amd64,linux/arm64/v8,linux/arm/v7,linux/s390x

                    # What are our version tags?
                    tags: |
                        webhood/2.7:${{ env.DATE }}
                        webhood/2.7:${{ env.LATEST }}

            -
                name: Build and push - Python 3.8
                uses: docker/build-push-action@v2

                with:
                    # Do we want to push the images to DockerHub?
                    push: true

                    # What is out build context?
                    file: template/Dockerfile-3.8
                    context: template

                    # What are our target platforms?
                    platforms: linux/amd64,linux/arm64/v8,linux/arm/v7,linux/s390x

                    # What are our version tags?
                    tags: |
                        webhood/3.8:${{ env.DATE }}
                        webhood/3.8:${{ env.LATEST }}